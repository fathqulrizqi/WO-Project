
@{
    ViewBag.Title = "Detail Working Order";
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.NavHide = true;

}

@section cssHead {
    <link href="~/Content/sweetalert2/sweetalert2.min.css" rel="stylesheet" />
    <link href="~/Content/air-datepicker/air-datepicker.css" rel="stylesheet" />
    <style>
        .page-content {
            padding-top: 0 !important;
        }

        #modalContent table.mce-table,
        #modalContent table.mce-table th,
        #modalContent table.mce-table td {
            border: 1px solid black !important;
            border-collapse: collapse !important;
        }

        .tox-edit-area table.mce-table,
        .tox-edit-area table.mce-table th,
        .tox-edit-area table.mce-table td {
            border: 1px solid black !important;
            border-collapse: collapse !important;
        }
    </style>
}

@section scriptHead {
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="~/Scripts/tinymce/tinymce.min.js"></script>
    <script src="~/Content/sweetalert2/sweetalert2@11.js"></script>
    <script src="~/Content/air-datepicker/air-datepicker.js"></script>

    <script src="@Url.Content("~/Scripts/accounting.min.js")"></script>

    <script>
       function getQueryParam(name) {
           const urlParams = new URLSearchParams(window.location.search);
           return urlParams.get(name);
       }

       $(document).ready(function () {
            $("#budgetNo").select2({
                dropdownParent: $("#letterbody"),
                width: "100%",
            });

           $("#savebutton").off("click").on("click", function (e) {
               e.preventDefault();

               const idLetter = $("#idLetter").val();

               if (idLetter && idLetter !== "0") {
                   UpdateLetterData();
               } else {
                   SaveLetterData();
               }
           });


    const queryId = getQueryParam("id"); 
    if (queryId) {
        $.ajax({
            url: '@Url.Action("GetDataById", "WorkingOrder", new { area = "Purchasing" })',
            type: 'GET',
            data: { id: queryId },
            success: function (res) {
                if (res && res.datas) {
                    const data = res.datas;

                    $("#vendor").text(data.VendorName);
                    $('#number').text(data.Number);

                    const today = new Date();
                    const formatted = `${String(today.getDate()).padStart(2, '0')}-${String(today.getMonth() + 1).padStart(2, '0')}-${today.getFullYear()}`;
                    $('#date').text(formatted);

                    $("#idList").val(data.ID);

                    loadLetterIfExists(data.ID);
                }
            },
            error: function () {
                Swal.fire('Error!', 'Failed to retrieve schedule data.', 'error');
            }
        });
    }

    $("#total").on("input", function () {
        let cursorPos = this.selectionStart;
        let originalLength = this.value.length;
        let numeric = unformatRupiah(this.value);
        let formatted = formatRupiah(numeric);
        $(this).val(formatted);
        let newLength = formatted.length;
        this.setSelectionRange(cursorPos + (newLength - originalLength), cursorPos + (newLength - originalLength));
    });
});

function loadLetterIfExists(idList) {
    $.ajax({
        url: '@Url.Action("GetLetterById", "WorkingOrder", new { area = "Purchasing" })',
        method: 'GET',
        data: { id: idList },
        success: function (response) {
            if (response.success) {
                
                const d = response.data;
                console.log('data', d);
                $('#idLetter').val(d.ID);
                $('#idList').val(d.IDList);
                $('#number').val(d.Number);
                $('#vendor').val(d.Vendor);
                $('#attn').val(d.Attn);
                $('#ref').val(d.Ref);
                $('#project').val(d.Project);
                tinymce.get('project-field').setContent(d.Html);
                $('#date').val(formatDotNetDate(d.Date));
                $("#total").val(formatRupiah(d.Total));
                $('#payment').val(d.PaymentTerm);
                $('#startDate').val(formatDotNetDate(d.StartDate));
                $('#endDate').val(formatDotNetDate(d.EndDate));
                $('#remark').val(d.Remark);

                if (d.BudgetNo) {
                    var newOption = new Option(d.BudgetNo + ' - ' + d.BudgetDesc, d.BudgetNo, true, true);
                    $('#budgetNo').append(newOption).trigger('change');
                }

            }
        },
        error: function () {
            Swal.fire('Error', 'Failed to load letter detail', 'error');
        }
    });
}


    </script>

    <script>


    function formatDotNetDate(dotNetDate) {
        const timestamp = parseInt(dotNetDate.replace(/[^0-9]/g, ""));
        const date = new Date(timestamp);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${day}-${month}-${year}`;
    }

    function formatRupiah(value) {
        return accounting.formatMoney(value, {
            symbol: "Rp ",
            precision: 0,
            thousand: ".",
            decimal: ","
        });
    }

    function unformatRupiah(value) {
        return value.replace(/[^0-9]/g, '');
    }



        function SaveLetterData() {
        const totalValue = unformatRupiah($("#total").val());
        const queryId = getQueryParam("id");

        $.ajax({
            url: '@Url.Action("SaveLetter", "WorkingOrder", new { area = "Purchasing" })',
            type: 'POST',
            data: {
                IDList: $("#idList").val(),
                Number: $("#number").text(),
                Vendor: $("#vendor").text(),
                Attn: $("#attn").val(),
                Ref: $("#ref").val(),
                Project: $("#project").val(),
                Html: tinymce.get("project-field")?.getContent() || "",
                Date: $("#date").text(),
                Total: totalValue,
                PaymentTerm: $("#payment").val(),
                StartDate: $("#startDate").val(),
                EndDate: $("#endDate").val(),
                BudgetNo: $("#budgetNo").val(),
                BudgetDesc: $("#budgetDesc").val(),
                Remark: $("#remark").val()
            },
            success: function (response) {
            if (response.success) {
                Swal.fire({
                    title: 'Success',
                    text: response.message,
                    icon: 'success',
                    showConfirmButton: false
                }).then(() => {
                    window.location.href = '@Url.Action("Detail", "WorkingOrder", new { area = "Purchasing" })' + '?id=' + queryId;
                });
            }
        },
        error: function () {
            Swal.fire('Error', 'Something went wrong', 'error');
        }
        });
        }

        function UpdateLetterData() {
            const totalValue = unformatRupiah($("#total").val());
            const idList = $("#idList").val();

            $.ajax({
                url: '@Url.Action("UpdateLetter", "WorkingOrder", new { area = "Purchasing" })',
                type: 'POST',
                data: {
                    id: $("#idLetter").val(),
                    IDList: $("#idList").val(),
                    Number: $("#number").text(),
                    Vendor: $("#vendor").text(),
                    Attn: $("#attn").val(),
                    Ref: $("#ref").val(),
                    Project: $("#project").val(),
                    Html: tinymce.get("project-field")?.getContent() || "",
                    Date: $("#date").text(),
                    Total: totalValue,
                    PaymentTerm: $("#payment").val(),
                    StartDate: $("#startDate").val(),
                    EndDate: $("#endDate").val(),
                    BudgetNo: $("#budgetNo").val(),
                    BudgetDesc: $("#budgetDesc").val(),
                    Remark: $("#remark").val()
                },
                success: function (response) {
                    if (response.success) {
                        Swal.fire({
                            title: 'Success',
                            text: response.message,
                            icon: 'success',
                            confirmButtonText: 'OK'
                        }).then(() => {
                            window.location.href = '@Url.Action("Detail", "WorkingOrder", new { area = "Purchasing" })' + '?id=' + queryId;
                        });
                    } else {
                        Swal.fire('Error', response.message, 'error');
                    }
                },
                error: function () {
                    Swal.fire('Error', 'Something went wrong', 'error');
                }
            });
        }


    </script>

    @*<script>
            document.addEventListener('DOMContentLoaded', function () {
                function datepicker(selector) {
                    new AirDatepicker(selector, {
                        dateFormat: 'dd-MM-yyyy',
                        minDate: new Date(),
                        locale: {
                            days: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
                            daysShort: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
                            daysMin: ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"],
                            months: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
                            monthsShort: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
                            today: "Today",
                            clear: "Clear",
                            firstDay: 0
                        },
                    });
                }

                datepicker("#startDate");
                datepicker("#endDate");
            });
        </script>*@



}

<body class="bg-gray-100 p-6">

    <div class="flex items-center rounded text-[#2C3E50] mb-4">
        <span class="text-[#F6AA04] font-bold text-xl mr-2">|</span>
        <h2 class="font-bold text-xl">Detail Working Order</h2>
    </div>

    <div class="flex justify-center">
        <button onclick="generateFullDoc()"
                class="mb-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 mx-2">
            Preview Full Document
        </button>
        <button class="mb-4 px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700"
                id="savebutton">
            Save Changes
        </button>

    </div>

    <div class="mb-4 bg-white border shadow mx-auto" style="width: 21cm; min-height: 29.7cm; padding: 2cm; font-size: 10pt;">
        <!-- Letter Head -->
        <div id="letterhead">
            <div class="flex justify-between items-center">
                <img src="~/Content/Images/niterra-logo.jpg" alt="logo" width="100" height="50" />
                @*<img src="https://placehold.co/100x50" alt="Logo 1" />*@
                <div class="text-center text-sm">
                    <p class="font-bold">PT Niterra Mobility Indonesia</p>
                    <p>Jl. Raya Jakarta-Bogor Km. 26,6 Ciracas</p>
                    <p>Jakarta Timur, Indonesia</p>
                </div>
                <img src="~/Content/Images/tuv-image.png" width="80" height="50" alt="tuv" />
                @*<img src="https://placehold.co/80x50" alt="Logo 2" />*@
            </div>
            <hr class="mt-2 border-t border-black" />
            <p class="text-lg font-bold text-center underline mt-4">
                WORKING ORDER CONFIRMATION
            </p>
            <p id="number" name="number" class="text-sm font-bold text-center underline"></p>
            <input type="hidden" id="idLetter" />
            <input type="hidden" id="idList" />
            <input type="hidden" id="timestamps" value="@ViewBag.Now" />
        </div>

        <!-- Letter Body -->
        <table id="letterbody" class="table-auto w-full mt-4">
            <tbody>
                <tr>
                    <td class="align-top w-[170px]">To</td>
                    <td><span id="vendor" name="vendor"></span></td>
                </tr>
                <tr>
                    <td class="align-top w-[170px]">Attn</td>
                    <td>
                        <input type="text"
                               name="attn"
                               id="attn"
                               placeholder="Attention"
                               class="border rounded w-full px-2" />
                    </td>
                </tr>
                <tr>
                    <td class="align-top w-[170px]">Ref Quotation No & Date</td>
                    <td>
                        <input type="text"
                               name="ref"
                               id="ref"
                               placeholder="Ref Quotation No & Date"
                               class="border rounded w-full px-2" />
                    </td>
                </tr>
                <tr>
                    <td class="align-top w-[170px]">Project</td>
                    <td>
                        <input type="text"
                               name="project"
                               id="project"
                               placeholder="Project Title"
                               class="border rounded w-full px-2" />
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <textarea id="project-field" class="w-full mt-2 borderTable">
                        <table class="table-auto border border-black border-collapse customTable mce-table">
                        @*<thead>
                        <tr>
                        <th class="border border-black px-2">No.</th>
                        <th class="border border-black px-2">Type</th>
                        <th class="border border-black px-2">Qty</th>
                            </tr>
                          </thead>
                        <tbody>
                        <tr>
                        <td class="border border-black px-2"></td>
                        <td class="border border-black px-2"></td>
                        <td class="border border-black px-2"></td>
                            </tr>
                        <tr>
                        <td class="border border-black px-2"></td>
                        <td class="border border-black px-2"></td>
                        <td class="border border-black px-2"></td>
                            </tr>
                          </tbody>*@
                        </table>
                </textarea>
                    </td>
                </tr>
                <tr>
                    <td class="align-top w-[170px]">Date</td>
                    <td><span id="date" name="date"></span></td>
                </tr>
                <tr>
                    <td class="align-top w-[170px]">Total</td>
                    <td>
                        <input type="text"
                               name="total"
                               id="total"
                               placeholder="Total"
                               class="border rounded w-full px-2" />
                    </td>
                </tr>
                <tr>
                    <td class="align-top w-[170px]">Payment Term</td>
                    <td>
                        <input type="text"
                               name="payment"
                               id="payment"
                               placeholder="Payment Term"
                               class="border rounded w-full px-2" />
                    </td>
                </tr>
                <tr>
                    <td class="align-top w-[170px]">Start Date</td>
                    <td>
                        <input type="text"
                               name="startDate"
                               id="startDate"
                               placeholder="Start Date"
                               autocomplete="off"
                               class="border rounded w-full px-2" />
                    </td>
                </tr>
                <tr>
                    <td class="align-top w-[170px]">End Date</td>
                    <td>
                        <input type="text"
                               name="endDate"
                               id="endDate"
                               placeholder="End Date"
                               autocomplete="off"
                               class="border rounded w-full px-2" />
                    </td>
                </tr>
                <tr>
                    <td class="align-top w-[170px]">Budget No</td>
                    <td>
                        <select name="budgetNo" id="budgetNo" class="border rounded w-full">
                            <option value="">Select Budget No</option>
                            <option value="UNB">UNB</option>
                            @foreach (var data in ViewBag.budgetList)
                            {
                                <option value="@data.Budget_No">
                                    @(data.Budget_No + " | " + data.Description)
                                </option>
                            }
                        </select>

                    </td>
                </tr>
                <tr>
                    <td class="align-top w-[170px]">Remark</td>
                    <td>
                        <input type="text"
                               name="remark"
                               id="remark"
                               placeholder="Remark"
                               class="border rounded w-full px-2" />
                    </td>
                </tr>
            </tbody>
        </table>
        <p>Please attach working order confirmation together with Invoice.</p>


        <!-- Approval Section -->
        <div id="approval">
            <div class="flex justify-end gap-12 mb-6">
                <div class="flex flex-col items-center gap-1">
                    <div class="text-[12px]">Approved By:</div>
                    <div class="w-12 h-12 bg-zinc-300 rounded-full"></div>
                    <div class="text-[12px] font-bold">(##NAMEAPPROVED##)</div>
                </div>
                <div class="flex flex-col items-center gap-1">
                    <div class="text-[12px]">Prepared By:</div>
                    <div class="w-12 h-12 bg-zinc-300 rounded-full"></div>
                    <div class="text-[12px] font-bold">(#NAMEPREPARED##)</div>
                </div>
            </div>
            <div class="flex flex-col items-start gap-1 mb-6 text-[10px] font-bold">
                <div class="mb-[50px]">CONFIRMATION RECEIVED BY SUPPLIER</div>
                <div>(NAME / SIGN / COMPANY STAMP)</div>
            </div>
        </div>
    </div>


    <!-- Combined Preview Output -->
    <div id="result" class="mt-6 flex justify-center hidden">

        <div style="width: 21cm; min-height: 29.7cm; padding: 2cm; font-size: 10pt;" class="bg-white border shadow text-[10pt]"></div>
    </div>

    <div id="previewModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded shadow-xl overflow-y-auto max-h-[90vh] w-[90vw] relative">
            <button onclick="closeModal()"
                    class="absolute top-2 right-2 bg-red-500 text-white rounded-full px-3 py-1 text-xs hover:bg-red-600">
                Close
            </button>
            <div id="modalContent" class="text-[10pt]"></div>
        </div>
    </div>


    <script>
        tinymce.init({
            selector: "#project-field",
            height: 300,
            base_url: "/node_modules/tinymce",
            plugins: "table code lists",
            toolbar:
                "undo redo | fontselect | fontsize | bold italic | alignleft aligncenter alignright | bullist numlist | table tablemergecells tablesplitcells | code ",
            menubar: false,
            content_style: `
                            table {
                                border-collapse: collapse !important;
                            }
                            table td,
                            table th {
                                border: 1px solid black !important;
                                font-size: 10px;
                            }
                        `,
            table_default_attributes: {
                border: '1',
                class: 'mce-table'
            },
            table_default_styles: {
                'border-collapse': 'collapse',
                'width': '50%',
                'border': '1px solid black'
            },
            table_cell_default_styles: {
                'border': '1px solid black',
                'font-size': '10px'
            },
            setup: function (editor) {
                editor.on('NewTable', function (e) {
                    e.table.className += ' mce-table';
                });
            }
        });


        function generateFullDoc() {
            const modal = document.getElementById("previewModal");
            const modalContent = document.getElementById("modalContent");

            const letterhead = document.getElementById("letterhead").outerHTML;
            const approval = document.getElementById("approval").outerHTML;
            const projectContent = tinymce.get("project-field").getContent().replace(/<table/g, '<table class="mce-table"');

            const attn = document.getElementById("attn").value;
            const ref = document.getElementById("ref").value;
            const project = document.getElementById("project").value;
            const date = document.getElementById("date")?.innerText ?? "";
            const total = document.getElementById("total").value;
            const payment = document.getElementById("payment").value;
            const startDate = document.getElementById("startDate").value;
            const endDate = document.getElementById("endDate").value;
            const budgetNo = document.getElementById("budgetNo").value;
            const remark = document.getElementById("remark").value;
            const vendor = document.getElementById("vendor")?.innerText ?? "##VENDOR##";

            const letterbody = `
                        <table class="table-fixed w-full text-[10px]">
                            <tbody>
                            <tr><td class="w-[170px] align-top">To</td><td>: ${vendor}</td></tr>
                            <tr><td class="w-[170px] align-top">Attn</td><td>: ${attn}</td></tr>
                            <tr><td class="w-[170px] align-top">Ref Quotation No & Date</td><td>: ${ref}</td></tr>
                            <tr><td class="w-[170px] align-top">Project</td><td class="max-w-[360px]">: ${project}<br>${projectContent}</td></tr>
                            <tr><td class="w-[170px] align-top">Date</td><td>: ${date}</td></tr>
                            <tr><td class="w-[170px] align-top">Total</td><td>: ${total}</td></tr>
                            <tr><td class="w-[170px] align-top">Payment Term</td><td>: ${payment}</td></tr>
                            <tr><td class="w-[170px] align-top">Start Date</td><td>: ${startDate}</td></tr>
                            <tr><td class="w-[170px] align-top">End Date</td><td>: ${endDate}</td></tr>
                            <tr><td class="w-[170px] align-top">Budget No</td><td>: ${budgetNo}</td></tr>
                            <tr><td class="w-[170px] align-top">Remark</td><td>: ${remark}</td></tr>
                            </tbody>
                        </table>
                        <p class="text-[10px] mt-2">Please attach working order confirmation together with Invoice.</p>
                        `;

            const fullDoc = `
                        <div style="width: 21cm; height: 29.7cm; padding: 2cm; font-size: 10pt;" class="bg-white border shadow mx-auto">
                            ${letterhead}
                            <div class="mt-6">${letterbody}</div>
                            <div class="mt-6">${approval}</div>
                        </div>
                        `;

            modalContent.innerHTML = fullDoc;
            modal.classList.remove("hidden");
        }
        function closeModal() {
            document.getElementById("previewModal").classList.add("hidden");
        }

        document.addEventListener("click", function (e) {
            const modal = document.getElementById("previewModal");
            const modalContent = document.getElementById("modalContent");
            if (!modal.classList.contains("hidden") && modal.contains(e.target) && !modalContent.contains(e.target)) {
                closeModal();
            }
        });

         $(function () {
             $("#printButton").click(function () {
                 //$("input[name='ExportData']").val($("#PrintPDF").html());
                 window.open('@Url.Action("GeneratePdf", "MatProm", new { area = "Marketing", RequestNo = ViewBag.RequestNo })', '_blank');
             });
         });

    </script>

    <script>
        function datepicker(selector) {
            new AirDatepicker(selector, {
                dateFormat: 'dd-MM-yyyy',
                minDate: new Date(),
                locale: {
                    days: ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"],
                    daysShort: ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
                    daysMin: ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"],
                    months: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
                    monthsShort: ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
                    today: "Today",
                    clear: "Clear",
                    firstDay: 0
                },
            });
        }

        datepicker("#startDate");
        datepicker("#endDate");

    </script>


</body>

